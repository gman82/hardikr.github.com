<html lang="en">
<head>
	<meta charset="utf-8" />
	<title> A Gentle Introduction to Node - 2 - A Day Without Chocolate </title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<link rel="stylesheet" href="http://localhost:4000/css/layout.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="http://localhost:4000/css/default.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic|Yanone+Kaffeesatz:regular,bold" />
	<link rel="icon" href="http://commondatastorage.googleapis.com/hardik/new.ico" type="image/x-icon">
	<!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript"></script>
	<script type="text/javascript">$(document).ready(function(){$("p:has(img)").css('padding-left', '0 !important');});</script>-->
	<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-19059213-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>
<body>
	<div class="wrap" id="page">
		<div class="payload">
			<div class="side">
			<a href="http://localhost:4000"><h2 style="padding-top:65px;color:#BEBEBE">A Day Without <span style="color:#7B3F00">[Chocolate]</span></h2></a>
				<div id="byline">
					<a href="http://localhost:4000/about.html"><span class="fancy">By</span> Hardik Ruparel</a>
				</div><!--/byline-->
				<div id="navigation">
					<ul>
						<li><a href="http://localhost:4000/essays">Essays</a></li>
						<li><a href="http://localhost:4000/archives.html">Archives</a></li>
						<li><a href="http://localhost:4000/about.html">About</a></li>
						<li><a href="http://localhost:4000/contact.html">Contact</a></li>
						<li><a href="http://localhost:4000/feeds.html">Feeds</a></li>
						<li><a href="https://twitter.com/hardikr">Twitter</a></li>
					</ul>
				</div><!--/navigation-->
				<a target="_blank" rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/"><img alt="Creative Commons License" style="border-width:0" id="cc" src="http://i.creativecommons.org/l/by-nc-nd/3.0/88x31.png" /></a>
			</div><!--/side-->
			<div class="main">
				
				<!--Post -->
<div id="post-" class="post">
	<h2>A Gentle Introduction to Node - 2</h2>
	<div class="post-meta">
	<div class="meta-date">April 22, 2011&nbsp;|&nbsp;<span class="perma"><a href="http://localhost:4000/js/node-2">Permalink</a></span></div>
	</div>

	<p>Previously: <a href='http://blog.hardikr.com/js/node-1/' title='The first post in the series'>A Gentle Introduction to Node - 1</a></p>

<p>If you&#8217;ve not read the first post, please read it ! (especially the <a href='http://blog.hardikr.com/js/node-1/#resources' title='Resources in first post'>resources</a> section to get a good understanding of how Node works.</p>

<p>So let&#8217;s dive in. We&#8217;re going to be building a simple looking homepage for me using a static file server in Node.JS. I agree that&#8217;s probably not what Node is best at, but at some point in your life you are going to want to serve static files to the browser.</p>

<p>Let&#8217;s dive in. The code may look big and mean, but it&#8217;s actually really easy to understand.</p>
<div class='highlight'><pre><span class='kd'>var</span> <span class='nx'>http</span> <span class='o'>=</span> <span class='nx'>require</span><span class='p'>(</span><span class='s1'>&#39;http&#39;</span><span class='p'>);</span>
<span class='kd'>var</span> <span class='nx'>url</span> <span class='o'>=</span> <span class='nx'>require</span><span class='p'>(</span><span class='s1'>&#39;url&#39;</span><span class='p'>);</span>
<span class='kd'>var</span> <span class='nx'>fs</span> <span class='o'>=</span> <span class='nx'>require</span><span class='p'>(</span><span class='s1'>&#39;fs&#39;</span><span class='p'>);</span>
<span class='kd'>var</span> <span class='nx'>server</span> <span class='o'>=</span> <span class='nx'>http</span><span class='p'>.</span><span class='nx'>createServer</span><span class='p'>(</span><span class='kd'>function</span> <span class='p'>(</span><span class='nx'>req</span><span class='p'>,</span><span class='nx'>res</span><span class='p'>)</span> <span class='p'>{</span>
	<span class='kd'>var</span> <span class='nx'>path</span> <span class='o'>=</span> <span class='nx'>url</span><span class='p'>.</span><span class='nx'>parse</span><span class='p'>(</span><span class='nx'>req</span><span class='p'>.</span><span class='nx'>url</span><span class='p'>).</span><span class='nx'>pathname</span><span class='p'>;</span>
	<span class='k'>switch</span><span class='p'>(</span><span class='nx'>path</span><span class='p'>)</span> <span class='p'>{</span>
	
	<span class='c1'>// This is a trivial implementation of URL routing.		</span>
	
		<span class='k'>case</span> <span class='s1'>&#39;/&#39;</span> <span class='o'>:</span>	
	<span class='nx'>res</span><span class='p'>.</span><span class='nx'>writeHead</span><span class='p'>(</span><span class='mi'>200</span><span class='p'>,</span> <span class='p'>{</span><span class='s1'>&#39;Content-Type&#39;</span> <span class='o'>:</span> <span class='s1'>&#39;text/html&#39;</span><span class='p'>});</span>
	<span class='nx'>res</span><span class='p'>.</span><span class='nx'>write</span><span class='p'>(</span><span class='s1'>&#39;Welcome, you have reached my homepage. &#39;</span> <span class='o'>+</span> 
	<span class='s1'>&#39;You can check out my twitter profile &#39;</span> <span class='o'>+</span> 
	<span class='s1'>&#39;&lt;a href=&quot;https://twitter.com/hardikr&quot;&gt;here&lt;/a&gt;&#39;</span> <span class='o'>+</span> 
	<span class='s1'>&#39;&lt;p&gt;Sitemap&lt;/p&gt;&#39;</span> <span class='o'>+</span> 
	<span class='s1'>&#39;&lt;li&gt;&lt;a href=&quot;about&quot;&gt;About&lt;/a&gt;&#39;</span> <span class='o'>+</span> 
	<span class='s1'>&#39;&lt;li&gt;&lt;a href=&quot;image.png&quot;&gt;My Favorite XKCD comic&lt;/a&gt;&#39;</span>
	<span class='p'>);</span>
	<span class='nx'>res</span><span class='p'>.</span><span class='nx'>end</span><span class='p'>();</span>
	<span class='k'>break</span><span class='p'>;</span>

		<span class='k'>case</span> <span class='s1'>&#39;/about&#39;</span> <span class='o'>:</span> 
	<span class='nx'>res</span><span class='p'>.</span><span class='nx'>writeHead</span><span class='p'>(</span><span class='mi'>200</span><span class='p'>,</span> <span class='p'>{</span><span class='s1'>&#39;Content-Type&#39;</span> <span class='o'>:</span> <span class='s1'>&#39;text/html&#39;</span><span class='p'>});</span>
	<span class='nx'>res</span><span class='p'>.</span><span class='nx'>write</span><span class='p'>(</span><span class='s1'>&#39;My name is Hardik. That\&#39;s all :| &#39;</span> <span class='o'>+</span> 
	<span class='s1'>&#39;&lt;br/&gt; &lt;a href=&quot;/&quot;&gt;Go Back&lt;/a&gt;&#39;</span>
	<span class='p'>);</span>
	<span class='nx'>res</span><span class='p'>.</span><span class='nx'>end</span><span class='p'>();</span>
	<span class='k'>break</span><span class='p'>;</span>

		<span class='k'>case</span> <span class='s1'>&#39;/image.png&#39;</span> <span class='o'>:</span> 
	<span class='nx'>fs</span><span class='p'>.</span><span class='nx'>readFile</span><span class='p'>(</span><span class='nx'>__dirname</span> <span class='o'>+</span> <span class='nx'>path</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>err</span><span class='p'>,</span> <span class='nx'>data</span><span class='p'>)</span> <span class='p'>{</span>
		<span class='k'>if</span><span class='p'>(</span><span class='nx'>err</span><span class='p'>)</span> <span class='k'>throw</span> <span class='nx'>err</span><span class='p'>;</span>
		<span class='nx'>res</span><span class='p'>.</span><span class='nx'>writeHead</span><span class='p'>(</span><span class='mi'>200</span><span class='p'>,</span> <span class='p'>{</span><span class='s1'>&#39;Content-Type&#39;</span> <span class='o'>:</span> <span class='s1'>&#39;image/png&#39;</span><span class='p'>});</span>
		<span class='nx'>res</span><span class='p'>.</span><span class='nx'>write</span><span class='p'>(</span><span class='nx'>data</span><span class='p'>,</span><span class='s1'>&#39;utf8&#39;</span><span class='p'>);</span>
		<span class='nx'>res</span><span class='p'>.</span><span class='nx'>end</span><span class='p'>();</span>
	<span class='p'>});</span>
	<span class='k'>break</span><span class='p'>;</span>

		<span class='k'>case</span> <span class='s1'>&#39;default&#39;</span><span class='o'>:</span> 	
	<span class='nx'>res</span><span class='p'>.</span><span class='nx'>writeHead</span><span class='p'>(</span><span class='mi'>404</span><span class='p'>,</span> <span class='p'>{</span><span class='s1'>&#39;Content-Type&#39;</span> <span class='o'>:</span> <span class='s1'>&#39;text/plain&#39;</span><span class='p'>});</span>
	<span class='nx'>res</span><span class='p'>.</span><span class='nx'>write</span><span class='p'>(</span><span class='s1'>&#39;Page Not Found. 404&#39;</span><span class='p'>);</span>
	<span class='nx'>res</span><span class='p'>.</span><span class='nx'>end</span><span class='p'>();</span>
	
	<span class='p'>}</span>

<span class='p'>}).</span><span class='nx'>listen</span><span class='p'>(</span><span class='mi'>8080</span><span class='p'>);</span>
<span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span><span class='s1'>&#39;Server started at http://localhost:8080&#39;</span><span class='p'>);</span>
</pre>
</div>
<p>As discussed before, Node uses modules which you can include in your code to let you do awesome stuff. Just like Python, Node is an uber-cool Swiss Army Knife, only there&#8217;s no limit to how far you can customize the modules you need to include. You can even use the hundreds of third party modules already available, and when you&#8217;re confident enough, you can build your own modules to serve your needs.</p>
<div class='highlight'><pre><span class='kd'>var</span> <span class='nx'>http</span> <span class='o'>=</span> <span class='nx'>require</span><span class='p'>(</span><span class='s1'>&#39;http&#39;</span><span class='p'>);</span>
<span class='kd'>var</span> <span class='nx'>url</span> <span class='o'>=</span> <span class='nx'>require</span><span class='p'>(</span><span class='s1'>&#39;url&#39;</span><span class='p'>);</span>
<span class='kd'>var</span> <span class='nx'>fs</span> <span class='o'>=</span> <span class='nx'>require</span><span class='p'>(</span><span class='s1'>&#39;fs&#39;</span><span class='p'>);</span>
</pre>
</div>
<p>So, we start off with importing the <code>http</code> module (which we used in the previous post), along with the <code>url</code> and the <code>fs</code> module. The <code>url</code> module lets us manipulate the URL fragment of the incoming request, which we&#8217;ll see later on, and the <code>fs</code> module is the File System module, which we&#8217;ll use to read a local file and display it to the browser.</p>
<div class='highlight'><pre><span class='kd'>var</span> <span class='nx'>server</span> <span class='o'>=</span> <span class='nx'>http</span><span class='p'>.</span><span class='nx'>createServer</span><span class='p'>(</span><span class='kd'>function</span> <span class='p'>(</span><span class='nx'>req</span><span class='p'>,</span><span class='nx'>res</span><span class='p'>)</span> <span class='p'>{</span>
 <span class='kd'>var</span> <span class='nx'>path</span> <span class='o'>=</span> <span class='nx'>url</span><span class='p'>.</span><span class='nx'>parse</span><span class='p'>(</span><span class='nx'>req</span><span class='p'>.</span><span class='nx'>url</span><span class='p'>).</span><span class='nx'>pathname</span><span class='p'>;</span>
</pre>
</div>
<p>Next, we initialize our server object, with our <code>req</code> (request) and <code>response</code> (response) objects coming in as parameters to the callback function. If you paid attention last week, you may have realized we never used the request object. Well, we&#8217;re gonna do that right now.</p>

<p>We parse the requested URL (that you type in the browser eg : <code>http://example.com/about</code> ) using the <code>url.parse</code> method of the <code>url</code> module we imported, and we extract the requested pathname. in the above URL, it is <code>/about</code>.</p>

<p>After that, it&#8217;s pretty self explanatory. We use the <code>switch</code> method (which I presume you know). The first case, we test for the root of our homepage - for which the pathname would be <code>/</code>. We write the response headers and body just like last time, and end the output with <code>res.end()</code>. Don&#8217;t forget to put your break statement. Similarly, we test for <code>/about</code> and send my about page.</p>
<div class='highlight'><pre><span class='nx'>fs</span><span class='p'>.</span><span class='nx'>readFile</span><span class='p'>(</span><span class='nx'>__dirname</span> <span class='o'>+</span> <span class='nx'>path</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>err</span><span class='p'>,</span> <span class='nx'>data</span><span class='p'>)</span> <span class='p'>{</span>
 <span class='k'>if</span><span class='p'>(</span><span class='nx'>err</span><span class='p'>)</span> <span class='k'>throw</span> <span class='nx'>err</span><span class='p'>;</span>
 <span class='nx'>res</span><span class='p'>.</span><span class='nx'>writeHead</span><span class='p'>(</span><span class='mi'>200</span><span class='p'>,</span> <span class='p'>{</span><span class='s1'>&#39;Content-Type&#39;</span> <span class='o'>:</span> <span class='s1'>&#39;image/png&#39;</span><span class='p'>});</span>
 <span class='nx'>res</span><span class='p'>.</span><span class='nx'>write</span><span class='p'>(</span><span class='nx'>data</span><span class='p'>,</span><span class='s1'>&#39;utf8&#39;</span><span class='p'>);</span>
 <span class='nx'>res</span><span class='p'>.</span><span class='nx'>end</span><span class='p'>();</span>
<span class='p'>});</span>
</pre>
</div>
<p>But now, I want to send over a PNG image as my favorite XKCD comic. I have a file named image.png lying in the same folder as my server.js file which I want to serve. Logically, I have to read the file from my Node.JS code first. I can do this with the <code>readFile</code> method.</p>

<p><code>__dirname</code> specifies the current working directory (where the Node server file is present), and we append to it the path that we extracted from <code>url.parse(req.url).pathname</code>; hence building the absolute path to the image.png file on the UNIX filesystem. We declare an anonymous callback function which will return the file as an object <code>data</code>.</p>

<p>I check for any errors, if found will be thrown. I write the HTTP response header, but this time my <code>Content-Type</code> is set to <code>image/png</code> since I&#8217;m returning a PNG image. I pass along the file object <code>data</code> which contains the PNG file and end my output stream with <code>res.end</code>.</p>

<p>The <code>default</code> case will be selected if the client requests one of the paths we&#8217;re not checking for; and it sends over a simple 404 error.</p>

<p>That&#8217;s pretty much it. We have our working homepage, and you can test it out! You can get to designing your webpage in Node and host it over at EC2 which I think is still offering one year of free micro-instances.</p>
<!--		<div class="meta-tags">
			<ul>
				
				<li><a href="http://localhost:4000/tag/node/" title="Posts tagged node">node</a></li>
				
				<li><a href="http://localhost:4000/tag/nodejs/" title="Posts tagged nodejs">nodejs</a></li>
				
				<li><a href="http://localhost:4000/tag/programming/" title="Posts tagged programming">programming</a></li>
				
				<li><a href="http://localhost:4000/tag/javascript/" title="Posts tagged javascript">javascript</a></li>
				
			</ul>
		</div> -->
	<hr class="pad" />
<!--	<div class="related-posts">
		<h3>Related Articles</h3>
		<ul class="posts">
		    
		      <li><span>09 Apr 2011</span> &raquo; <a href="/js/node-1">A Gentle Introduction to Node - 1</a></li>
		    
		      <li><span>03 Apr 2011</span> &raquo; <a href="/india/mumbai-locals">Twenty Minutes on a Mumbai local train</a></li>
		    
		      <li><span>26 Mar 2011</span> &raquo; <a href="/tech/eightbit-hijack">Apparently, Eightbit.me has hijacked my Twitter profile photo!</a></li>
		    
		  </ul>
	</div> -->
</div>
<div class="paginator">
  
  <div class="left_column">
    
      <a href="/js/node-1" title="A Gentle Introduction to Node - 1">&larr; Previous</a>
    
  </div>

  <div class="right_column">
    
  </div>
  
  <div class="clear_both">
  </div>
  
</div>

				
				<div class="footer">
					<div class="footer-copynone">Theme borrowed from <a href="http://coffeecomrade.com/">coffeecomrade.com</a>. Powered by <a href="http://github.com/mojombo/jekyll">Jekyll</a>. Hosted on <a href="http://github.com/">Github</a></div>
					</div><!--/footer-->
			</div><!--/main-->
		</div><!--/payload-->
	</div><!--/wrap-->
</body>
</html>
